# Docker build for IoT testbed pentest
# january 28 2020

FROM ubuntu:18.04 as ubu
MAINTAINER s.lazarus@unsw.edu.au

# NOT needed if we mount ./pentest:/pentest
# WORKDIR /pentest
# COPY requirements.txt /pentest/requirements.txt 

# non-interactive when installing packages
ENV DEBIAN_FRONTEND noninteractive
# update image and get some essentials
RUN apt-get update && apt-get upgrade -y && apt-get install apt-utils locales gnupg2 ca-certificates apt-transport-https wget
ENV LANG='en_US.UTF-8' LANGUAGE='en_US:en' LC_ALL='en_US.UTF-8'
# python3 goes bonkers if these are not set


# perl, ruby...oh my this takes time
RUN apt-get install -y net-tools iptables python3-dev perl libwww-perl nikto hydra \
 python3-pip python python-pip libatlas-base-dev libopenjp2-7 python3-tk tshark python-lxml \
 git wget graphviz libgraphviz-dev pkg-config nmap python-pycurl \
 smbclient sslscan iputils-ping gem rubygems ruby-dev zlib1g-dev libcurl4-gnutls-dev && \
 perl -MCPAN -e 'install Net::SNMP' && perl -MCPAN -e 'install Crypt::CBC' && perl -MCPAN -e 'install Number::Bytes::Human' && \
 gem install wpscan && \
 git clone https://github.com/portcullislabs/enum4linux.git /root/enum4linux && ln -s /root/enum4linux/enum4linux.pl /usr/local/bin

FROM ubu as ubu2

RUN  pip3 install -r requirements.txt && \
 git clone https://github.com/darkoperator/dnsrecon.git /root/dnsrecon && \
 cp /root/dnsrecon/dnsrecon.py /root/dnsrecon/dnsrecon && \
 chmod +x /root/dnsrecon/dnsrecon && ln -s /root/dnsrecon/dnsrecon /usr/local/bin && \
 git clone https://github.com/ShawnDEvans/smbmap.git /root/smbmap && cd /root/smbmap && pip3 install -r requirements.txt && \
 ln -s /root/smbmap/smbmap.py /usr/local/bin && \
 wget https://raw.githubusercontent.com/pwnieexpress/pwn_plug_sources/master/src/snmpcheck/snmpcheck-1.8.pl -O /root/snmpcheck-1.8.pl && \ 
 chmod  +x /root/snmpcheck-1.8.pl && ln -s /root/snmpcheck-1.8.pl /usr/local/bin && \
 wget https://raw.githubusercontent.com/curesec/tools/master/snmp/snmp-walk.py -O /root/snmp-walk.py && chmod +x /root/snmp-walk.py && ln -s /root/snmp-walk.py /usr/local/bin && \
 git clone https://github.com/rezasp/joomscan.git /root/joomscan && chmod +x /root/joomscan/joomscan.pl && ln -s /root/joomscan/joomscan.pl /usr/local/bin && \
 sed -i "1s/.*/\#\!\/usr\/bin\/perl\ \-\-/" /root/joomscan/joomscan.pl && \
 rm /var/www/html/index.nginx-debian.html

# set up secur_iot tools
RUN git clone https://github.com/slazaru/secur_IOT.git /root/secur_IOT && \
 mkdir -p /usr/share/wordlists && \
 cp /root/secur_IOT/common.txt /usr/share/wordlists/common.txt && \
 cp /root/secur_IOT/extensions.txt /usr/share/wordlists/extensions.txt && \
 cp /root/secur_IOT/sshPasswords1.txt /usr/share/wordlists/sshPasswords1.txt && \
 cp /root/secur_IOT/sshUsers1.txt /usr/share/wordlists/sshUsers1.txt 

# Clean up APT when done.
#RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

ENTRYPOINT /etc/init.d/ssh restart && service nginx restart && /bin/bash
